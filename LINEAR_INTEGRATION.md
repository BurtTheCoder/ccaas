# Linear Integration Documentation

## Overview

The Claude Code Service now includes direct Linear integration, allowing you to automate issue management, trigger workflows based on Linear events, and create/update issues from your workflows.

## Features

- **Native Linear API Integration**: Direct integration with Linear's GraphQL API using the official `@linear/sdk`
- **Webhook Support**: Receive and process Linear webhook events (issue creation, updates, comments, etc.)
- **Issue Management**: Create, update, and comment on Linear issues from workflows
- **Team & Project Management**: Query teams, projects, and workflow states
- **Workflow Automation**: Trigger multi-agent workflows when Linear issues are created or updated
- **Database Logging**: All Linear webhook events and operations are logged to the database

## Setup

### 1. Get Linear API Credentials

1. Go to Linear Settings -> API -> Personal API Keys
2. Create a new API key with appropriate permissions
3. Copy the API key

### 2. Configure Webhook (Optional)

1. Go to Linear Settings -> API -> Webhooks
2. Create a new webhook
3. Set the URL to: `https://your-domain.com/api/webhooks/linear`
4. Select the events you want to receive (e.g., Issue created, Issue updated)
5. Copy the webhook secret

### 3. Set Environment Variables

Add these to your `.env` file:

```bash
# Linear Integration
LINEAR_API_KEY=lin_api_xxxxxxxxxxxxxxxxxxxxx
LINEAR_WEBHOOK_SECRET=your_webhook_secret_here
```

### 4. Create Integration Configuration

Use the tRPC endpoint or UI to create an integration configuration that maps a Linear team to a CCAAS project:

```typescript
// Example tRPC call
await trpc.linear.createConfig.mutate({
  projectId: 1,
  linearTeamId: "TEAM-ID-HERE",
  linearTeamName: "Engineering",
  eventTypes: ["Issue.create", "Issue.update"],
  isActive: true,
});
```

## Usage

### Triggering Workflows from Linear Issues

When a Linear issue is created with an automation label (e.g., `safe-for-automation`, `automation`, or `claude-code`), the system will:

1. Receive the webhook event
2. Look up the integration configuration for that team
3. Load the associated project's workflow configuration
4. Execute the workflow with Linear issue context

The workflow receives these context variables:

```yaml
LINEAR_ISSUE_ID: "abc123"
LINEAR_ISSUE_IDENTIFIER: "ENG-123"
LINEAR_ISSUE_TITLE: "Fix login bug"
LINEAR_ISSUE_DESCRIPTION: "Users can't log in..."
LINEAR_ISSUE_URL: "https://linear.app/your-workspace/issue/ENG-123"
LINEAR_TEAM_ID: "team-id"
LINEAR_TEAM_NAME: "Engineering"
LINEAR_PROJECT_ID: "project-id" # if assigned
```

### Creating Linear Issues from Workflows

You can create Linear issues from within your workflow using actions:

```yaml
agents:
  - name: "reporter"
    role: "Create a Linear issue for tracking"
    prompt: "Summarize the findings and create an issue"
    output: "REPORT"
    conditions:
      - if: "REPORT contains 'critical'"
        then:
          - type: "linear.createIssue"
            teamId: "{{LINEAR_TEAM_ID}}"
            title: "Critical Issue Found: {{ISSUE_SUMMARY}}"
            description: "{{REPORT}}"
            priority: 1
            labels: ["bug", "critical"]
        next: null
```

### Updating Linear Issues

Update issue status, assignee, or other fields:

```yaml
conditions:
  - if: "TEST_RESULT contains 'PASSED'"
    then:
      - type: "linear.updateIssue"
        issueId: "{{LINEAR_ISSUE_ID}}"
        updates:
          stateId: "completed-state-id"
          assigneeId: "user-id"
    next: null
```

### Adding Comments

Add comments to Linear issues:

```yaml
conditions:
  - if: "ANALYSIS_COMPLETE"
    then:
      - type: "linear.addComment"
        issueId: "{{LINEAR_ISSUE_ID}}"
        body: |
          ## Analysis Complete

          {{ANALYSIS_RESULT}}

          ---
          Generated by Claude Code Service
    next: "next_agent"
```

## API Reference

### tRPC Endpoints

All endpoints are under the `linear` router:

#### Testing

- **`linear.test`**: Test Linear API connection
  - Returns: `{ success: boolean, message: string }`

#### Teams & Projects

- **`linear.teams`**: List all teams
  - Input: `{ forceRefresh?: boolean }`
  - Returns: `Array<{ id, name, key }>`

- **`linear.projects`**: List projects for a team
  - Input: `{ teamId?: string }`
  - Returns: `Array<{ id, name }>`

- **`linear.workflowStates`**: Get workflow states for a team
  - Input: `{ teamId: string }`
  - Returns: `Array<{ id, name, type, color }>`

#### Issues

- **`linear.issues`**: Get recent issues
  - Input: `{ teamId?: string, limit?: number }`
  - Returns: `Array<Issue>`

- **`linear.createIssue`**: Create a new issue
  - Input: `{ teamId, title, description?, priority?, assigneeId?, projectId?, labels?, stateId? }`
  - Returns: `{ id, identifier, title, url }`

- **`linear.addComment`**: Add comment to an issue
  - Input: `{ issueId, body }`
  - Returns: `{ id }`

#### Integration Configuration

- **`linear.configs`**: List all integration configs
  - Returns: `Array<LinearIntegrationConfig>`

- **`linear.getConfig`**: Get config by ID
  - Input: `{ id: number }`
  - Returns: `LinearIntegrationConfig`

- **`linear.getConfigByProject`**: Get config for a project
  - Input: `{ projectId: number }`
  - Returns: `LinearIntegrationConfig`

- **`linear.createConfig`**: Create integration config
  - Input: `{ projectId, linearTeamId, linearTeamName?, eventTypes, webhookUrl?, isActive? }`
  - Returns: `LinearIntegrationConfig`

- **`linear.updateConfig`**: Update integration config
  - Input: `{ id, linearProjectId?, eventTypes?, webhookUrl?, isActive? }`
  - Returns: `LinearIntegrationConfig`

- **`linear.deleteConfig`**: Delete integration config
  - Input: `{ id: number }`
  - Returns: `{ success: true }`

#### Webhook Events

- **`linear.webhookEvents`**: List webhook events
  - Input: `{ limit?: number, processed?: boolean }`
  - Returns: `Array<LinearWebhookEvent>`

## Webhook Events

The Linear integration listens for these webhook events:

- **`Issue.create`**: New issue created
- **`Issue.update`**: Issue updated (status, assignee, etc.)
- **`Issue.remove`**: Issue deleted
- **`Comment.create`**: New comment added
- **`Comment.update`**: Comment updated
- **`Comment.remove`**: Comment deleted

## Database Schema

### `linearWebhookEvents`

Stores all incoming Linear webhook events:

```typescript
{
  id: number;
  webhookId: string;
  eventType: string;
  action: string;
  type: string;
  issueId?: string;
  issueIdentifier?: string;
  organizationId: string;
  workflowId?: string;
  executionId?: string;
  payload: Record<string, any>;
  processed: boolean;
  createdAt: Date;
}
```

### `linearIntegrationConfig`

Stores integration configuration per project/team:

```typescript
{
  id: number;
  projectId: number;
  linearTeamId: string;
  linearTeamName?: string;
  linearProjectId?: string;
  linearProjectName?: string;
  eventTypes: string[];
  webhookUrl?: string;
  isActive: boolean;
  createdAt: Date;
  updatedAt: Date;
}
```

## Example Workflow

See [`examples/linear-issue-automation.yaml`](./examples/linear-issue-automation.yaml) for a complete example workflow that:

1. Analyzes a Linear issue
2. Executes required changes
3. Tests the changes
4. Updates the Linear issue with results
5. Handles errors gracefully

## Security

### Webhook Signature Verification

All Linear webhooks are verified using HMAC-SHA256 signatures. The webhook handler:

1. Reads the `linear-signature` header
2. Computes HMAC-SHA256 of the raw request body using `LINEAR_WEBHOOK_SECRET`
3. Performs constant-time comparison to prevent timing attacks
4. Rejects requests with invalid signatures

### API Key Security

- Store `LINEAR_API_KEY` in environment variables, never in code
- Use appropriate Linear API key permissions (read-only where possible)
- Rotate API keys periodically
- Monitor API usage through Linear's dashboard

### Access Control

- Only issues with automation labels trigger workflows
- Integration configs can be enabled/disabled per project
- All Linear operations are logged to the database for audit purposes
- Webhook events are validated before processing

## Error Handling

The integration includes graceful error handling:

- **Missing API Key**: Operations log warnings and return null, don't throw errors
- **Network Failures**: Retries with exponential backoff (handled by Linear SDK)
- **Invalid Webhook Signatures**: Rejected with 401 status
- **Missing Integration Config**: Events are logged but no workflow is triggered
- **Workflow Failures**: Errors are logged to database and Linear issue is updated

## Caching

Team and project data is cached for 5 minutes to reduce API calls:

```typescript
const teams = await linearClient.getTeams(); // Cached
const teams = await linearClient.getTeams(true); // Force refresh
```

## Monitoring

### Check Integration Status

```typescript
const status = await trpc.linear.test.query();
// Returns: { success: true, message: "Linear API connection successful..." }
```

### View Webhook Events

```typescript
const events = await trpc.linear.webhookEvents.query({ limit: 50, processed: false });
```

### Review Logs

All Linear operations are logged:

```sql
SELECT * FROM logs WHERE message LIKE '%[Linear]%' ORDER BY timestamp DESC LIMIT 100;
```

## Troubleshooting

### Webhook not triggering workflows

1. Check that `LINEAR_WEBHOOK_SECRET` is set correctly
2. Verify the integration config exists and `isActive = true`
3. Check that the issue has an automation label
4. Review webhook events: `trpc.linear.webhookEvents.query()`
5. Check server logs for `[Linear Webhook]` messages

### API calls failing

1. Verify `LINEAR_API_KEY` is valid
2. Test connection: `trpc.linear.test.query()`
3. Check Linear API key permissions
4. Review Linear SDK logs in server output

### Issues not updating

1. Verify you have write permissions in Linear
2. Check that state IDs and assignee IDs are valid
3. Review logs for error messages
4. Ensure workflow actions have correct Linear issue context

## Best Practices

1. **Use Automation Labels**: Only trigger automation on explicitly labeled issues
2. **Test in Staging**: Set up a test Linear workspace for development
3. **Monitor Costs**: Track workflow executions and set budget limits
4. **Handle Failures Gracefully**: Always include error handling in workflows
5. **Document Automations**: Add comments to Linear issues explaining what was automated
6. **Review Regularly**: Check webhook event logs to ensure proper operation
7. **Limit Scope**: Start with simple automations and expand gradually

## Support

For issues or questions:
1. Check server logs for detailed error messages
2. Review the webhook events table for debugging
3. Test API connectivity with `trpc.linear.test`
4. Consult Linear's API documentation: https://developers.linear.app/

## Version History

- **1.0.0** (2025-11-02): Initial Linear integration release
  - Native API client
  - Webhook support
  - Issue management
  - Workflow automation
  - Database logging

name: "Linear Issue Automation"
description: "Automatically process Linear issues labeled for automation"
version: "1.0.0"

workflow:
  max_iterations: 10
  max_consecutive_failures: 2
  budget:
    daily_max_cost: "$5.00"
  context:
    # These will be injected by the webhook handler when an issue is created
    LINEAR_ISSUE_ID: ""
    LINEAR_ISSUE_IDENTIFIER: ""
    LINEAR_ISSUE_TITLE: ""
    LINEAR_ISSUE_DESCRIPTION: ""
    LINEAR_ISSUE_URL: ""
    LINEAR_TEAM_ID: ""
    LINEAR_TEAM_NAME: ""

agents:
  # Agent 1: Analyze the issue
  - name: "analyzer"
    role: "Analyze the Linear issue and determine what needs to be done"
    prompt: |
      You are analyzing a Linear issue to determine what actions should be taken.

      Issue: {{LINEAR_ISSUE_IDENTIFIER}} - {{LINEAR_ISSUE_TITLE}}
      Description: {{LINEAR_ISSUE_DESCRIPTION}}
      URL: {{LINEAR_ISSUE_URL}}

      Based on the issue description, determine:
      1. What type of issue is this (bug fix, feature request, documentation, etc.)?
      2. What specific actions should be taken?
      3. Is this issue actionable? Can it be automated?
      4. What files or systems need to be modified?

      Provide your analysis as a structured response that can be used by subsequent agents.
    output: "ANALYSIS_RESULT"
    container:
      workingDir: "/workspace"
      tools:
        - Read
        - Glob
        - Grep
    next: "executor"

  # Agent 2: Execute the required changes
  - name: "executor"
    role: "Execute the changes based on the analysis"
    prompt: |
      Based on the analysis:
      {{ANALYSIS_RESULT}}

      Execute the necessary changes to address the Linear issue.

      Original Issue: {{LINEAR_ISSUE_IDENTIFIER}} - {{LINEAR_ISSUE_TITLE}}

      Guidelines:
      - Make precise, targeted changes
      - Follow existing code patterns and conventions
      - Add appropriate tests if needed
      - Document your changes clearly

      When complete, provide a summary of the changes made.
    output: "EXECUTION_RESULT"
    container:
      workingDir: "/workspace"
      tools:
        - Read
        - Write
        - Edit
        - Glob
        - Grep
        - Bash
    next: "tester"

  # Agent 3: Test the changes
  - name: "tester"
    role: "Verify the changes work correctly"
    prompt: |
      Verify that the changes made for issue {{LINEAR_ISSUE_IDENTIFIER}} work correctly.

      Changes made:
      {{EXECUTION_RESULT}}

      Tasks:
      1. Run existing tests to ensure nothing broke
      2. Create new tests if needed
      3. Verify the issue requirements are met
      4. Check for any edge cases or potential problems

      Provide a summary of test results.
    output: "TEST_RESULT"
    container:
      workingDir: "/workspace"
      tools:
        - Read
        - Write
        - Bash
        - Grep
    conditions:
      - if: "TEST_RESULT contains 'PASSED'"
        then:
          - type: "linear.addComment"
            issueId: "{{LINEAR_ISSUE_ID}}"
            body: |
              ## Automated Resolution Complete

              The issue has been automatically processed and tested.

              **Analysis:**
              {{ANALYSIS_RESULT}}

              **Changes Made:**
              {{EXECUTION_RESULT}}

              **Test Results:**
              {{TEST_RESULT}}

              ---
              Generated by Claude Code Service
          - type: "linear.updateIssue"
            issueId: "{{LINEAR_ISSUE_ID}}"
            updates:
              stateId: "completed"  # Move to completed state
        next: null
      - else:
        then:
          - type: "linear.addComment"
            issueId: "{{LINEAR_ISSUE_ID}}"
            body: |
              ## Automation Failed

              The automated processing encountered issues during testing.

              **Analysis:**
              {{ANALYSIS_RESULT}}

              **Changes Made:**
              {{EXECUTION_RESULT}}

              **Test Failure:**
              {{TEST_RESULT}}

              Manual review required.

              ---
              Generated by Claude Code Service
        next: "error_handler"

  # Agent 4: Error handler
  - name: "error_handler"
    role: "Handle errors and create appropriate notifications"
    prompt: |
      The automated processing failed for issue {{LINEAR_ISSUE_IDENTIFIER}}.

      Create a clear summary of what went wrong and what needs manual attention.

      Test results:
      {{TEST_RESULT}}
    output: "ERROR_SUMMARY"
    container:
      workingDir: "/workspace"
      tools:
        - Read
    next: null
